# 🔍 デプロイ検証チェックリスト

## 現在の状態

### ✅ 完了している項目

- [x] コードのセキュリティ修正完了
- [x] GitHubにプッシュ済み
- [x] GitHub Actions ワークフロー作成済み
- [x] GitHub Secrets 設定済み
- [x] Azure基本認証の有効化済み
- [x] 発行プロファイルの設定済み

### GitHub Actions の状態

最新のワークフロー実行：
- **実行 #37**: ✅ 成功（2分5秒）
- **コミット**: 8dbeea8

確認URL: https://github.com/suzuki651/my-website4/actions

---

## 🔧 Azure App Service 確認項目

### 1. App Service の起動状態を確認

**確認手順**:

1. **Azure Portal にアクセス**
   ```
   https://portal.azure.com
   ```

2. **App Services → tmsystem を選択**

3. **「概要」ページで以下を確認**:

   **確認項目**:
   - **状態**: 「実行中」になっているか？
     - ✅ 実行中 → OK
     - ❌ 停止 → 「開始」ボタンをクリック

   - **URL**: `https://tmsystem.azurewebsites.net`
     - クリックしてアクセスできるか確認

   - **既定のドメイン**: 正しく設定されているか

### 2. アプリケーションログを確認

**確認手順**:

1. **左メニュー「ログストリーム」をクリック**

2. **ログが表示されるか確認**:

   **正常な場合のログ例**:
   ```
   勤怠管理システム - Azure App Service版を起動しています...
   データベース初期化完了
   管理者アカウント作成完了
   一時パスワード: AuZwwU7xwpI2m5U9poV_Yw
   システム起動完了！
   * Running on http://0.0.0.0:8000
   ```

   **エラーがある場合**:
   - エラーメッセージをコピー
   - 下記のトラブルシューティングを参照

### 3. 環境変数を確認

**確認手順**:

1. **左メニュー「環境変数」または「構成」をクリック**

2. **「アプリケーション設定」タブを選択**

3. **以下の7つの変数が設定されているか確認**:

   - [ ] `SECRET_KEY`
   - [ ] `FLASK_ENV` = `production`
   - [ ] `SMTP_SERVER` = `smtp.gmail.com`
   - [ ] `SMTP_PORT` = `587`
   - [ ] `EMAIL_USERNAME` = `suzuki651iris1@gmail.com`
   - [ ] `EMAIL_PASSWORD`
   - [ ] `ADMIN_EMAIL` = `suzuki651iris1@gmail.com`

   **すべて設定されていますか？**
   - ✅ はい → OK
   - ❌ いいえ → `SECRETS_VALUES.txt` を参照して追加

### 4. デプロイ履歴を確認

**確認手順**:

1. **左メニュー「デプロイセンター」をクリック**

2. **「ログ」タブを選択**

3. **最新のデプロイ状態を確認**:

   - **状態**: 成功（緑色のチェックマーク）
   - **日時**: 最新のコミット時刻
   - **コミットID**: 8dbeea8

   **失敗している場合**:
   - 詳細ログを確認
   - エラーメッセージをコピー

---

## 🌐 アプリケーション動作確認

### 1. メインページにアクセス

**URL**: https://tmsystem.azurewebsites.net

**確認項目**:
- [ ] ページが表示される
- [ ] エラーメッセージが表示されない
- [ ] QRコード打刻画面が表示される

### 2. 管理画面にアクセス

**URL**: https://tmsystem.azurewebsites.net/admin/login

**確認項目**:
- [ ] ログインフォームが表示される
- [ ] ユーザー名とパスワードの入力欄がある

**ログイン情報**:
- ユーザー名: `admin`
- パスワード: ログストリームに表示された一時パスワード

### 3. 管理機能の確認

ログイン後、以下を確認：

- [ ] 従業員一覧が表示される
- [ ] 打刻記録が表示される
- [ ] QRコード生成機能が動作する
- [ ] エクスポート機能が動作する

---

## 🐛 トラブルシューティング

### 問題1: アプリケーションにアクセスできない

**症状**:
- `https://tmsystem.azurewebsites.net` にアクセスできない
- "This site can't be reached" エラー

**確認事項**:

1. **App Service が起動しているか**
   - Azure Portal → tmsystem → 概要
   - 状態が「実行中」か確認
   - 停止している場合は「開始」をクリック

2. **デプロイが成功しているか**
   - デプロイセンター → ログ
   - 最新のデプロイが成功（緑色）か確認

3. **アプリケーションログを確認**
   - ログストリーム
   - 起動エラーがないか確認

### 問題2: 500 Internal Server Error

**症状**:
- ページにアクセスすると500エラー

**確認事項**:

1. **環境変数が設定されているか**
   - 環境変数 → アプリケーション設定
   - 7つの変数が正しく設定されているか

2. **SECRET_KEY が設定されているか**
   - `SECRET_KEY` が空でないか
   - デフォルト値（`your_super_secret_key_change_in_production`）のままでないか

3. **ログストリームでエラーを確認**
   ```
   致命的エラー: SECRET_KEYが設定されていない
   ```
   このようなエラーがある場合は環境変数を設定

### 問題3: デプロイは成功するが起動しない

**症状**:
- GitHub Actions は成功
- しかしアプリケーションにアクセスできない

**確認事項**:

1. **startup.py が正しく実行されているか**
   - ログストリームを確認
   - "Starting Gunicorn" のようなメッセージがあるか

2. **Pythonのバージョンが正しいか**
   - App Service → 構成 → 全般設定
   - Python バージョン: 3.11

3. **依存パッケージがインストールされているか**
   - デプロイセンター → ログ
   - `pip install -r requirements.txt` が成功しているか

### 問題4: データベースエラー

**症状**:
- "database is locked" エラー
- "unable to open database file" エラー

**解決策**:

1. **App Service を再起動**
   - Azure Portal → tmsystem → 概要
   - 上部メニュー「再起動」をクリック

2. **データベースファイルのパスを確認**
   - ログストリームで以下を確認：
   ```
   データベースパス: /home/...
   ```

3. **永続ストレージが有効か確認**
   - 構成 → 全般設定
   - 「常時接続」: オン

---

## 📊 最終確認チェックリスト

すべて完了したらチェック：

### GitHub
- [ ] リポジトリに最新コードがプッシュされている
- [ ] GitHub Secrets が8つ設定されている
- [ ] GitHub Actions が成功している

### Azure App Service
- [ ] App Service が「実行中」状態
- [ ] 環境変数が7つ設定されている
- [ ] デプロイが成功している
- [ ] ログストリームにエラーがない

### アプリケーション
- [ ] https://tmsystem.azurewebsites.net にアクセスできる
- [ ] 管理画面にログインできる
- [ ] QRコード生成が動作する
- [ ] 打刻機能が動作する

---

## 🎉 すべて完了したら

**おめでとうございます！**

勤怠管理システムが正常にデプロイされました。

### 次のステップ

1. **管理者パスワードを変更**
   - 管理画面にログイン
   - 設定 → パスワード変更
   - 安全なパスワードに変更

2. **従業員を登録**
   - 管理画面 → 従業員管理
   - 新規従業員を追加

3. **QRコードを発行**
   - 従業員ごとにQRコードを生成
   - 印刷して配布

4. **動作確認**
   - モバイルページで打刻テスト
   - 管理画面で記録確認

---

**最終更新**: 2025-01-07
**バージョン**: 1.0
