<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹¤æ€ æ‰“åˆ» - é¡”èªè¨¼å¯¾å¿œ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        body { 
            text-align: center; 
            font-family: 'Arial', sans-serif; 
            background-color: #f8f9fa; 
        }
        .container { 
            padding: 20px; 
            max-width: 600px; 
            margin: 0 auto; 
        }
        .punch-buttons { 
            margin-top: 20px; 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 15px; 
        }
        .punch-buttons button {
            flex-grow: 1; 
            max-width: 150px; 
            min-height: 60px;
            font-size: 1.1em; 
            border-radius: 8px; 
            transition: all 0.3s;
        }
        .punch-buttons button:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); 
        }
        .qr-section { 
            margin-top: 30px; 
            display: none; 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .qr-reader { 
            width: 100%; 
            max-width: 400px; 
            margin: 0 auto; 
            border: 3px solid #9b4dca; 
            border-radius: 12px; 
            overflow: hidden; 
        }
        .face-auth-section {
            margin-top: 20px; 
            background: white; 
            padding: 20px;
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
        }
        .face-video-container {
            position: relative;
            width: 100%; 
            max-width: 350px;
            margin: 0 auto;
        }
        #face-video {
            width: 100%; 
            height: 250px;
            border: 3px solid #007bff;
            border-radius: 10px;
            object-fit: cover;
        }
        .face-overlay {
            position: absolute;
            top: 0; 
            left: 0;
            width: 100%; 
            height: 100%;
            pointer-events: none;
        }
        .face-status {
            margin: 15px 0;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .face-detected { background-color: #d4edda; color: #155724; }
        .face-not-detected { background-color: #fff3cd; color: #856404; }
        .face-verified { background-color: #d1ecf1; color: #0c5460; }
        .face-failed { background-color: #f8d7da; color: #721c24; }
        .similarity-display {
            font-size: 1.2em;
            margin: 10px 0;
        }
        .message-box {
            margin-top: 20px; 
            padding: 15px; 
            border-radius: 8px; 
            font-weight: bold;
            animation: slideIn 0.5s ease-out;
        }
        .success { background-color: #d4edda; color: #155724; border-left: 5px solid #28a745; }
        .error {
            background-color: #f8d7da; 
            color: #721c24; 
            border-left: 5px solid #dc3545;
            animation: shake 0.6s ease-in-out;
        }
        .status-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            padding: 20px; 
            border-radius: 10px; 
            margin-bottom: 20px;
        }
        .current-time { font-size: 1.5em; margin-bottom: 10px; }
        .settings-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
        }
        .toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px; width: 18px;
            left: 3px; bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2196F3;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #9b4dca;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        .face-init-status {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
        }
        .face-init-loading { background-color: #fff3cd; color: #856404; }
        .face-init-success { background-color: #d4edda; color: #155724; }
        .face-init-error { background-color: #f8d7da; color: #721c24; }
        .face-init-disabled { background-color: #e9ecef; color: #6c757d; }
        .auto-punch-countdown {
            margin: 15px 0;
            padding: 20px;
            border-radius: 8px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            font-size: 1.5em;
            font-weight: bold;
            animation: pulse 1s infinite;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            display: none;
        }
        .countdown-number {
            font-size: 2.5em;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .photo-capture-status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
            display: none;
        }
        .photo-capturing { background-color: #fff3cd; color: #856404; }
        .photo-captured { background-color: #d4edda; color: #155724; }
        .photo-failed { background-color: #f8d7da; color: #721c24; }
        .photo-preview {
            margin: 10px 0;
            text-align: center;
            display: none;
        }
        .photo-preview img {
            max-width: 200px;
            height: auto;
            border-radius: 8px;
            border: 2px solid #28a745;
        }
        .photo-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .photo-popup-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }
        .photo-popup img {
            max-width: 100%;
            max-height: 70vh;
            border-radius: 8px;
        }
        .photo-popup-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            cursor: pointer;
            color: #666;
        }
        .photo-popup-close:hover {
            color: #000;
        }
        #manual-punch-section {
            margin-top: 40px; 
            background: white; 
            padding: 20px;
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .system-status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
            background-color: #e9ecef;
            color: #495057;
            border-left: 4px solid #007bff;
        }
        /* æ‰‹å‹•æ‰“åˆ»ç”¨ã®å†™çœŸé–¢é€£ã‚¹ã‚¿ã‚¤ãƒ« */
        .manual-photo-section {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
            display: none;
        }
        .manual-photo-status {
            margin: 10px 0;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.85em;
            text-align: center;
            display: none;
        }
        .manual-photo-preview {
            margin: 10px 0;
            text-align: center;
            display: none;
        }
        .manual-photo-preview img {
            max-width: 150px;
            height: auto;
            border-radius: 6px;
            border: 2px solid #28a745;
            cursor: pointer;
        }
        .manual-camera-video {
            width: 100%;
            max-width: 300px;
            height: 200px;
            border: 2px solid #007bff;
            border-radius: 8px;
            object-fit: cover;
            margin: 10px auto;
            display: none;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes shake {
            0%, 20%, 40%, 60%, 80% { transform: translateX(-10px); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(10px); }
            100% { transform: translateX(0); }
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="status-display">
            <div class="current-time" id="current-time"></div>
            <div>å‹¤æ€ æ‰“åˆ»ã‚·ã‚¹ãƒ†ãƒ  - é¡”èªè¨¼å¯¾å¿œ</div>
        </div>

        <div id="system-status" class="system-status">
            ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³: <span id="system-status-text">å¾…æ©Ÿä¸­</span>
        </div>

        <div id="face-init-status" class="face-init-status face-init-loading">
            <div class="loading-spinner"></div>
            <div>é¡”èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ä¸­...</div>
        </div>

        <div class="settings-panel">
            <h3>è¨­å®š</h3>
            <div class="setting-item">
                <span>é¡”èªè¨¼ã‚’æœ‰åŠ¹ã«ã™ã‚‹</span>
                <label class="toggle">
                    <input type="checkbox" id="faceAuthEnabled" checked onchange="toggleFaceAuth()">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <span>éŸ³å£°ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</span>
                <label class="toggle">
                    <input type="checkbox" id="voiceEnabled" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <span>é¡”èªè¨¼æˆåŠŸæ™‚ã®è‡ªå‹•æ‰“åˆ»</span>
                <label class="toggle">
                    <input type="checkbox" id="autoPunchEnabled" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <span>å†™çœŸæ’®å½±ã‚’æœ‰åŠ¹ã«ã™ã‚‹</span>
                <label class="toggle">
                    <input type="checkbox" id="photoCaptureEnabled" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <span>éŸ³å£°ãƒœãƒªãƒ¥ãƒ¼ãƒ </span>
                <input type="range" id="volumeControl" min="0.1" max="2.0" step="0.1" value="1.0" style="width: 100px;">
                <span id="volumeDisplay">100%</span>
            </div>
        </div>

        <h2>æ‰“åˆ»ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠ</h2>
        <div class="punch-buttons">
            <button class="button button-outline" onclick="startPunch('in')" style="border-color: #28a745; color: #28a745;">
                <i class="fas fa-sign-in-alt"></i> å‡ºå‹¤
            </button>
            <button class="button button-outline" onclick="startPunch('out_personal')" style="border-color: #ffc107; color: #ffc107;">
                <i class="fas fa-door-open"></i> é€€å‡º
            </button>
            <button class="button button-outline" onclick="startPunch('in_personal')" style="border-color: #17a2b8; color: #17a2b8;">
                <i class="fas fa-door-closed"></i> æˆ»ã‚Š
            </button>
            <button class="button button-outline" onclick="startPunch('out')" style="border-color: #dc3545; color: #dc3545;">
                <i class="fas fa-sign-out-alt"></i> é€€å‹¤
            </button>
        </div>

        <div id="qr-section" class="qr-section">
            <h3>QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„</h3>
            <div class="qr-reader">
                <div id="reader"></div>
            </div>
            <button onclick="cancelQrScan()" class="button button-outline" style="margin-top: 15px;">
                <i class="fas fa-times"></i> ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
        </div>

        <div id="face-auth-section" class="face-auth-section">
            <h3>é¡”èªè¨¼ã‚’å®Ÿè¡Œä¸­</h3>
            <div class="face-video-container">
                <video id="face-video" autoplay muted playsinline></video>
                <canvas id="face-overlay" class="face-overlay"></canvas>
            </div>
            <div id="face-status" class="face-status face-not-detected">
                é¡”ã‚’æ¤œå‡ºä¸­...
            </div>
            <div id="similarity-display" class="similarity-display"></div>

            <div id="photo-capture-status" class="photo-capture-status">
                å†™çœŸã‚’æ’®å½±ä¸­...
            </div>

            <div id="photo-preview" class="photo-preview">
                <div>æ’®å½±ã•ã‚ŒãŸå†™çœŸ:</div>
                <img id="captured-photo" alt="æ’®å½±å†™çœŸ">
            </div>

            <div id="auto-punch-countdown" class="auto-punch-countdown">
                è‡ªå‹•æ‰“åˆ»ã¾ã§ <span id="countdown-number" class="countdown-number">3</span> ç§’
            </div>
            <div style="margin-top: 15px;">
                <button id="proceed-btn" onclick="proceedToPunch()" disabled class="button" style="background-color: #28a745;">
                    <i class="fas fa-check"></i> æ‰“åˆ»å®Ÿè¡Œ
                </button>
                <button onclick="skipFaceAuth()" class="button button-outline">
                    <i class="fas fa-skip-forward"></i> é¡”èªè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—
                </button>
                <button onclick="cancelFaceAuth()" class="button button-outline">
                    <i class="fas fa-times"></i> ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
            </div>
        </div>

        <div id="message" class="message-box" style="display:none;"></div>

        <!-- å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
        <div id="photo-popup" class="photo-popup">
            <div class="photo-popup-content">
                <span class="photo-popup-close" onclick="closePhotoPopup()">&times;</span>
                <h3>æ’®å½±å†™çœŸ</h3>
                <img id="popup-photo" alt="æ’®å½±å†™çœŸ">
                <div style="margin-top: 15px; text-align: center;">
                    <button onclick="closePhotoPopup()" class="button">é–‰ã˜ã‚‹</button>
                </div>
            </div>
        </div>

        <hr>

        <div id="manual-punch-section">
            <h2>æ‰‹å‹•ã§æ‰“åˆ»</h2>
            <form id="manual-punch-form">
                <div class="form-group">
                    <label for="manual_employee_id">å¾“æ¥­å“¡ID:</label>
                    <input type="text" id="manual_employee_id" required>
                </div>
                <div class="form-group">
                    <label for="manual_action">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:</label>
                    <select id="manual_action" required>
                        <option value="in">å‡ºå‹¤</option>
                        <option value="out">é€€å‹¤</option>
                        <option value="out_personal">é€€å‡º</option>
                        <option value="in_personal">æˆ»ã‚Š</option>
                    </select>
                </div>
                
                <!-- æ‰‹å‹•æ‰“åˆ»ç”¨ã®å†™çœŸæ’®å½±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="manual-photo-section" id="manual-photo-section">
                    <h4><i class="fas fa-camera"></i> å†™çœŸæ’®å½±</h4>
                    <video id="manual-camera-video" class="manual-camera-video" autoplay muted playsinline></video>
                    
                    <div id="manual-photo-status" class="manual-photo-status photo-capturing">
                        ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...
                    </div>
                    
                    <div id="manual-photo-preview" class="manual-photo-preview">
                        <div>æ’®å½±æ¸ˆã¿å†™çœŸ:</div>
                        <img id="manual-captured-photo" alt="æ‰‹å‹•æ’®å½±å†™çœŸ" onclick="showPhotoPopup(this.src)">
                    </div>
                    
                    <div style="margin-top: 10px;">
                        <button type="button" onclick="startManualPhotoCapture()" class="button button-outline">
                            <i class="fas fa-video"></i> ã‚«ãƒ¡ãƒ©é–‹å§‹
                        </button>
                        <button type="button" onclick="captureManualPhoto()" class="button" id="manual-photo-capture-btn" disabled>
                            <i class="fas fa-camera"></i> å†™çœŸæ’®å½±
                        </button>
                        <button type="button" onclick="stopManualPhotoCapture()" class="button button-outline">
                            <i class="fas fa-stop"></i> ã‚«ãƒ¡ãƒ©åœæ­¢
                        </button>
                    </div>
                </div>
                
                <button type="submit" class="button"><i class="fas fa-clock"></i> æ‰‹å‹•æ‰“åˆ»</button>
            </form>
            <div id="manual-message" class="message-box" style="display:none;"></div>
        </div>
    </div>

    <audio id="error-sound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmkaAV2o5PW6Ztx4OxRKnzxnyQ==" type="audio/wav">
    </audio>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®å®£è¨€
        let currentAction = null;
        let currentEmployeeId = null;
        let html5QrCode = null;
        let faceApiLoaded = false;
        let faceApiInitialized = false;
        let faceDetectionInterval = null;
        let currentFaceDescriptor = null;
        let storedFaceDescriptor = null;
        let faceVerified = false;
        let faceSimilarity = 0;
        let faceCanvas = null;
        let faceCtx = null;
        let autoPunchCountdown = null;
        let currentVolume = 1.0;
        let isAutoPunchInProgress = false;
        let faceAuthStarted = false;
        let lastCapturedPhoto = null;
        let faceAuthCompleted = false;
        let faceDetectionStopped = false;

        // æ‰‹å‹•æ‰“åˆ»ç”¨ã®å†™çœŸæ’®å½±é–¢é€£å¤‰æ•°
        let manualCameraStream = null;
        let manualPhotoCaptured = null;

        // DOMè¦ç´ ã®å‚ç…§
        const faceVideoElement = document.getElementById('face-video');
        const messageElement = document.getElementById('message');
        const qrSection = document.getElementById('qr-section');
        const faceAuthSection = document.getElementById('face-auth-section');
        const errorSound = document.getElementById('error-sound');
        const manualCameraVideo = document.getElementById('manual-camera-video');

        // åˆæœŸåŒ–å‡¦ç†
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹');
            updateSystemStatus('åˆæœŸåŒ–ä¸­');

            try {
                await initializeFaceApi();
                setupEventListeners();
                updateCurrentTime();
                setInterval(updateCurrentTime, 1000);
                initVolumeControl();
                initManualPhotoSettings();

                updateSystemStatus('å¾…æ©Ÿä¸­');
                console.log('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
            } catch (error) {
                console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            }
        });

        // æ‰‹å‹•æ‰“åˆ»ç”¨å†™çœŸæ’®å½±è¨­å®šã®åˆæœŸåŒ–
        function initManualPhotoSettings() {
            const photoCaptureEnabled = document.getElementById('photoCaptureEnabled');
            const manualPhotoSection = document.getElementById('manual-photo-section');
            
            function toggleManualPhotoSection() {
                if (photoCaptureEnabled.checked) {
                    manualPhotoSection.style.display = 'block';
                } else {
                    manualPhotoSection.style.display = 'none';
                    stopManualPhotoCapture();
                }
            }
            
            toggleManualPhotoSection();
            photoCaptureEnabled.addEventListener('change', toggleManualPhotoSection);
        }

        function updateSystemStatus(status) {
            const statusElement = document.getElementById('system-status-text');
            if (statusElement) {
                statusElement.textContent = status;
            }
        }

        function initVolumeControl() {
            const volumeControl = document.getElementById('volumeControl');
            const volumeDisplay = document.getElementById('volumeDisplay');

            if (volumeControl && volumeDisplay) {
                volumeControl.addEventListener('input', function(e) {
                    currentVolume = parseFloat(e.target.value);
                    volumeDisplay.textContent = Math.round(currentVolume * 100) + '%';
                });
            }
        }

        function updateFaceInitStatus(status, message) {
            const statusDiv = document.getElementById('face-init-status');
            if (!statusDiv) return;

            statusDiv.className = 'face-init-status face-init-' + status;

            if (status === 'loading') {
                statusDiv.innerHTML = '<div class="loading-spinner"></div><div>' + message + '</div>';
            } else {
                statusDiv.innerHTML = '<div>' + message + '</div>';
            }

            if (status === 'success' || status === 'disabled') {
                setTimeout(function() {
                    statusDiv.style.display = 'none';
                }, 3000);
            }
        }

        async function initializeFaceApi() {
            try {
                console.log('face-api.jsåˆæœŸåŒ–é–‹å§‹');
                updateFaceInitStatus('loading', 'é¡”èªè¨¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã¿ä¸­...');

                let attempts = 0;
                const maxAttempts = 30;

                while (typeof faceapi === 'undefined' && attempts < maxAttempts) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    attempts++;
                }

                if (typeof faceapi === 'undefined') {
                    console.error('face-api.jsã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    updateFaceInitStatus('error', 'é¡”èªè¨¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }

                updateFaceInitStatus('loading', 'ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...');

                try {
                    const modelBaseUrl = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';

                    await Promise.all([
                        faceapi.nets.tinyFaceDetector.loadFromUri(modelBaseUrl),
                        faceapi.nets.faceLandmark68Net.loadFromUri(modelBaseUrl),
                        faceapi.nets.faceRecognitionNet.loadFromUri(modelBaseUrl)
                    ]);

                    faceApiLoaded = true;
                    faceApiInitialized = true;
                    updateFaceInitStatus('success', 'é¡”èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã—ãŸ');

                } catch (modelError) {
                    console.warn('CDNã‹ã‚‰ã®ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿å¤±æ•—ã€ä»£æ›¿æ‰‹æ®µã‚’è©¦è¡Œä¸­...', modelError);

                    try {
                        updateFaceInitStatus('loading', 'ä»£æ›¿æ–¹æ³•ã§ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ä¸­...');
                        await Promise.all([
                            faceapi.nets.tinyFaceDetector.loadFromUri('/static/models'),
                            faceapi.nets.faceLandmark68Net.loadFromUri('/static/models'),
                            faceapi.nets.faceRecognitionNet.loadFromUri('/static/models')
                        ]);

                        faceApiLoaded = true;
                        faceApiInitialized = true;
                        updateFaceInitStatus('success', 'é¡”èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã—ãŸï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ‡ãƒ«ä½¿ç”¨ï¼‰');

                    } catch (localError) {
                        console.error('ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ã‚‚å¤±æ•—:', localError);
                        faceApiLoaded = false;
                        faceApiInitialized = false;
                        document.getElementById('faceAuthEnabled').checked = false;
                        updateFaceInitStatus('disabled', 'é¡”èªè¨¼æ©Ÿèƒ½ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¾ã—ãŸï¼ˆãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿å¤±æ•—ï¼‰');
                    }
                }

            } catch (error) {
                console.error('face-api.jsåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                updateFaceInitStatus('error', 'é¡”èªè¨¼åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + error.message);
                faceApiLoaded = false;
                faceApiInitialized = false;
                document.getElementById('faceAuthEnabled').checked = false;
            }
        }

        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleString('ja-JP', {
                timeZone: 'Asia/Tokyo',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            const timeElement = document.getElementById('current-time');
            if (timeElement) {
                timeElement.textContent = timeString;
            }
        }

        // æ‰‹å‹•æ‰“åˆ»ç”¨å†™çœŸæ’®å½±æ©Ÿèƒ½
        async function startManualPhotoCapture() {
            try {
                console.log('æ‰‹å‹•æ’®å½±ç”¨ã‚«ãƒ¡ãƒ©é–‹å§‹');
                const manualPhotoStatus = document.getElementById('manual-photo-status');
                const captureBtn = document.getElementById('manual-photo-capture-btn');
                
                if (manualPhotoStatus) {
                    manualPhotoStatus.textContent = 'ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...';
                    manualPhotoStatus.className = 'manual-photo-status photo-capturing';
                    manualPhotoStatus.style.display = 'block';
                }

                const constraints = {
                    video: {
                        facingMode: 'user',
                        width: { ideal: 640, min: 320 },
                        height: { ideal: 480, min: 240 }
                    }
                };

                manualCameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                manualCameraVideo.srcObject = manualCameraStream;
                manualCameraVideo.style.display = 'block';

                await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ'));
                    }, 10000);

                    manualCameraVideo.addEventListener('loadedmetadata', () => {
                        clearTimeout(timeout);
                        console.log('æ‰‹å‹•æ’®å½±ç”¨ã‚«ãƒ¡ãƒ©æº–å‚™å®Œäº†');
                        if (manualPhotoStatus) {
                            manualPhotoStatus.textContent = 'æ’®å½±æº–å‚™å®Œäº†';
                            manualPhotoStatus.className = 'manual-photo-status photo-captured';
                        }
                        if (captureBtn) {
                            captureBtn.disabled = false;
                        }
                        resolve();
                    }, { once: true });
                });

            } catch (error) {
                console.error('æ‰‹å‹•æ’®å½±ç”¨ã‚«ãƒ¡ãƒ©é–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
                const manualPhotoStatus = document.getElementById('manual-photo-status');
                if (manualPhotoStatus) {
                    manualPhotoStatus.textContent = 'ã‚«ãƒ¡ãƒ©èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ';
                    manualPhotoStatus.className = 'manual-photo-status photo-failed';
                }
                alert('ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        function captureManualPhoto() {
            try {
                console.log('æ‰‹å‹•å†™çœŸæ’®å½±å®Ÿè¡Œ');
                
                if (!manualCameraVideo || !manualCameraVideo.srcObject || !manualCameraVideo.videoWidth) {
                    alert('ã‚«ãƒ¡ãƒ©ãŒæº–å‚™ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å…ˆã«ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                const canvas = document.createElement('canvas');
                canvas.width = manualCameraVideo.videoWidth;
                canvas.height = manualCameraVideo.videoHeight;
                const context = canvas.getContext('2d');

                context.drawImage(manualCameraVideo, 0, 0, canvas.width, canvas.height);
                const photoData = canvas.toDataURL('image/jpeg', 0.9);

                if (!photoData || photoData === 'data:,' || photoData.length < 1000) {
                    alert('å†™çœŸã®æ’®å½±ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }

                manualPhotoCaptured = photoData;

                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                const manualPhotoPreview = document.getElementById('manual-photo-preview');
                const manualCapturedPhoto = document.getElementById('manual-captured-photo');
                if (manualPhotoPreview && manualCapturedPhoto) {
                    manualCapturedPhoto.src = photoData;
                    manualPhotoPreview.style.display = 'block';
                }

                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
                const manualPhotoStatus = document.getElementById('manual-photo-status');
                if (manualPhotoStatus) {
                    manualPhotoStatus.textContent = 'å†™çœŸæ’®å½±å®Œäº†';
                    manualPhotoStatus.className = 'manual-photo-status photo-captured';
                }

                playPhotoCaptureSound();
                console.log('æ‰‹å‹•å†™çœŸæ’®å½±å®Œäº†: ' + Math.round(photoData.length / 1024) + 'KB');

            } catch (error) {
                console.error('æ‰‹å‹•å†™çœŸæ’®å½±ã‚¨ãƒ©ãƒ¼:', error);
                alert('å†™çœŸæ’®å½±ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        function stopManualPhotoCapture() {
            console.log('æ‰‹å‹•æ’®å½±ç”¨ã‚«ãƒ¡ãƒ©åœæ­¢');
            
            if (manualCameraStream) {
                manualCameraStream.getTracks().forEach(track => track.stop());
                manualCameraStream = null;
            }

            if (manualCameraVideo) {
                manualCameraVideo.srcObject = null;
                manualCameraVideo.style.display = 'none';
            }

            const manualPhotoStatus = document.getElementById('manual-photo-status');
            if (manualPhotoStatus) {
                manualPhotoStatus.style.display = 'none';
            }

            const captureBtn = document.getElementById('manual-photo-capture-btn');
            if (captureBtn) {
                captureBtn.disabled = true;
            }

            // ä¿®æ­£: ã‚«ãƒ¡ãƒ©åœæ­¢æ™‚ã«å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚‚éè¡¨ç¤ºã«ã™ã‚‹
            const manualPhotoPreview = document.getElementById('manual-photo-preview');
            if (manualPhotoPreview) {
                manualPhotoPreview.style.display = 'none';
            }

            // æ’®å½±æ¸ˆã¿å†™çœŸãƒ‡ãƒ¼ã‚¿ã‚‚ã‚¯ãƒªã‚¢
            manualPhotoCaptured = null;
            console.log('æ‰‹å‹•æ’®å½±ç”¨ã‚«ãƒ¡ãƒ©åœæ­¢å®Œäº†ã€å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚‚éè¡¨ç¤ºã«ã—ã¾ã—ãŸ');
        }

        // å†™çœŸæ’®å½±é–¢é€£ã®æ©Ÿèƒ½
        function updatePhotoCaptureStatus(status, message) {
            const statusDiv = document.getElementById('photo-capture-status');
            if (statusDiv) {
                statusDiv.className = 'photo-capture-status photo-' + status;
                statusDiv.textContent = message;
                statusDiv.style.display = 'block';

                if (status === 'captured' || status === 'failed') {
                    setTimeout(function() {
                        statusDiv.style.display = 'none';
                    }, 3000);
                }
            }
        }

        function showPhotoPopup(photoDataUrl) {
            if (!photoDataUrl) return;

            const popup = document.getElementById('photo-popup');
            const popupImg = document.getElementById('popup-photo');

            if (popup && popupImg) {
                popupImg.src = photoDataUrl;
                popup.style.display = 'flex';

                setTimeout(function() {
                    closePhotoPopup();
                }, 3000);
            }
        }

        function closePhotoPopup() {
            const popup = document.getElementById('photo-popup');
            if (popup) {
                popup.style.display = 'none';
            }
        }

        function showPhotoPreview(photoDataUrl) {
            if (!photoDataUrl) return;

            const previewDiv = document.getElementById('photo-preview');
            const imgElement = document.getElementById('captured-photo');

            if (previewDiv && imgElement) {
                imgElement.src = photoDataUrl;
                previewDiv.style.display = 'block';

                setTimeout(function() {
                    previewDiv.style.display = 'none';
                }, 5000);
            }
        }

        async function capturePhotoOnFaceAuth() {
            try {
                updatePhotoCaptureStatus('capturing', 'å†™çœŸã‚’æ’®å½±ä¸­...');
                console.log('é¡”èªè¨¼æ™‚å†™çœŸæ’®å½±é–‹å§‹');

                if (!faceVideoElement) {
                    console.error('faceVideoElementãŒå­˜åœ¨ã—ã¾ã›ã‚“');
                    updatePhotoCaptureStatus('failed', 'å†™çœŸæ’®å½±å¤±æ•—: ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }

                await new Promise(resolve => setTimeout(resolve, 800));

                const photoData = await capturePhotoFromFaceVideo();

                if (photoData && photoData.length > 1000) {
                    lastCapturedPhoto = photoData;
                    updatePhotoCaptureStatus('captured', 'å†™çœŸæ’®å½±å®Œäº†');
                    showPhotoPreview(photoData);
                    showPhotoPopup(photoData);
                    playPhotoCaptureSound();

                    console.log('é¡”èªè¨¼æ™‚å†™çœŸæ’®å½±æˆåŠŸ: ' + Math.round(photoData.length / 1024) + 'KB');
                } else {
                    console.error('å†™çœŸãƒ‡ãƒ¼ã‚¿ãŒç„¡åŠ¹:', photoData ? photoData.length : 'null');
                    updatePhotoCaptureStatus('failed', 'å†™çœŸæ’®å½±ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

            } catch (error) {
                console.error('é¡”èªè¨¼æ™‚å†™çœŸæ’®å½±ã‚¨ãƒ©ãƒ¼:', error);
                updatePhotoCaptureStatus('failed', 'å†™çœŸæ’®å½±ã‚¨ãƒ©ãƒ¼');
            }
        }

        function capturePhotoFromFaceVideo() {
            return new Promise(function(resolve) {
                try {
                    if (!faceVideoElement || !faceVideoElement.srcObject || 
                        !faceVideoElement.videoWidth || faceVideoElement.readyState < 2) {
                        resolve(null);
                        return;
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = faceVideoElement.videoWidth;
                    canvas.height = faceVideoElement.videoHeight;
                    const context = canvas.getContext('2d');

                    context.drawImage(faceVideoElement, 0, 0, canvas.width, canvas.height);

                    if (faceCanvas && currentFaceDescriptor && faceCtx) {
                        try {
                            const imageData = faceCtx.getImageData(0, 0, faceCanvas.width, faceCanvas.height);
                            let hasContent = false;
                            for (let i = 3; i < imageData.data.length; i += 4) {
                                if (imageData.data[i] > 0) {
                                    hasContent = true;
                                    break;
                                }
                            }

                            if (hasContent) {
                                const tempCanvas = document.createElement('canvas');
                                tempCanvas.width = faceCanvas.width;
                                tempCanvas.height = faceCanvas.height;
                                const tempCtx = tempCanvas.getContext('2d');
                                tempCtx.putImageData(imageData, 0, 0);
                                context.drawImage(tempCanvas, 0, 0, canvas.width, canvas.height);
                            }
                        } catch (overlayError) {
                            console.warn('é¡”æ¤œå‡ºæ åˆæˆã‚¨ãƒ©ãƒ¼:', overlayError);
                        }
                    }

                    const dataUrl = canvas.toDataURL('image/jpeg', 0.95);

                    if (!dataUrl || dataUrl === 'data:,' || dataUrl.length < 1000) {
                        resolve(null);
                        return;
                    }

                    resolve(dataUrl);

                } catch (error) {
                    console.error('é¡”èªè¨¼ç”¨å†™çœŸæ’®å½±ã‚¨ãƒ©ãƒ¼:', error);
                    resolve(null);
                }
            });
        }

        function capturePhoto() {
            return new Promise(function(resolve) {
                try {
                    let video = null;
                    if (faceVideoElement && faceVideoElement.srcObject && faceVideoElement.videoWidth) {
                        video = faceVideoElement;
                    } else {
                        resolve(null);
                        return;
                    }

                    if (!video.videoWidth || !video.videoHeight || video.readyState < 2) {
                        resolve(null);
                        return;
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const context = canvas.getContext('2d');

                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.9);

                    if (!dataUrl || dataUrl === 'data:,' || dataUrl.length < 1000) {
                        resolve(null);
                        return;
                    }

                    resolve(dataUrl);

                } catch (error) {
                    console.error('é€šå¸¸å†™çœŸæ’®å½±ã‚¨ãƒ©ãƒ¼:', error);
                    resolve(null);
                }
            });
        }

        function playPhotoCaptureSound() {
            try {
                const context = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = context.createOscillator();
                const gainNode = context.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(context.destination);

                oscillator.frequency.value = 1000;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0, context.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.2 * currentVolume, context.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, context.currentTime + 0.1);

                oscillator.start(context.currentTime);
                oscillator.stop(context.currentTime + 0.1);
            } catch (error) {
                console.error('å†™çœŸæ’®å½±éŸ³ç”Ÿæˆå¤±æ•—:', error);
            }
        }

        function setupEventListeners() {
            const manualPunchForm = document.getElementById('manual-punch-form');
            if (manualPunchForm) {
                manualPunchForm.addEventListener('submit', async function(event) {
                    event.preventDefault();
                    const form = event.target;
                    const manualEmployeeId = form.manual_employee_id.value.trim();
                    const manualAction = form.manual_action.value;

                    updateSystemStatus('æ‰‹å‹•æ‰“åˆ»å‡¦ç†ä¸­');

                    if (!manualEmployeeId) {
                        showManualMessage('å¾“æ¥­å“¡IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                        playErrorSound();
                        speak('å¾“æ¥­å“¡IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                        updateSystemStatus('ã‚¨ãƒ©ãƒ¼');
                        return;
                    }

                    const consistencyCheck = await checkPunchConsistency(manualEmployeeId, manualAction);
                    if (!consistencyCheck.success) {
                        showManualMessage(consistencyCheck.message, 'error');
                        playErrorSound();
                        speak(consistencyCheck.message);
                        updateSystemStatus('ã‚¨ãƒ©ãƒ¼');
                        return;
                    }

                    const actionNames = {
                        'in': 'å‡ºå‹¤',
                        'out': 'é€€å‹¤',
                        'out_personal': 'é€€å‡º',
                        'in_personal': 'æˆ»ã‚Š'
                    };

                    if (!confirm(consistencyCheck.employee_name + 'ã•ã‚“ã®' + actionNames[manualAction] + 'ã‚’ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ')) {
                        updateSystemStatus('ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
                        return;
                    }

                    // æ‰‹å‹•æ‰“åˆ»æ™‚ã®å†™çœŸãƒ‡ãƒ¼ã‚¿å–å¾—
                    let photoData = null;
                    if (document.getElementById('photoCaptureEnabled').checked) {
                        if (manualPhotoCaptured) {
                            photoData = manualPhotoCaptured;
                            console.log('æ‰‹å‹•æ’®å½±å†™çœŸä½¿ç”¨: ' + Math.round(photoData.length / 1024) + 'KB');
                        } else {
                            console.log('å†™çœŸæ’®å½±ãŒæœ‰åŠ¹ã§ã™ãŒæ’®å½±æ¸ˆã¿å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“');
                            if (confirm('å†™çœŸãŒæ’®å½±ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å†™çœŸãªã—ã§æ‰“åˆ»ã‚’ç¶™ç¶šã—ã¾ã™ã‹ï¼Ÿ')) {
                                photoData = null;
                            } else {
                                updateSystemStatus('å†™çœŸæ’®å½±å¾…ã¡');
                                alert('å…ˆã«å†™çœŸã‚’æ’®å½±ã—ã¦ã‹ã‚‰æ‰“åˆ»ã—ã¦ãã ã•ã„');
                                return;
                            }
                        }
                    }

                    const data = {
                        employee_id: manualEmployeeId,
                        action: manualAction,
                        photo: photoData
                    };

                    try {
                        const response = await fetch('/api/timecard/manual', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify(data)
                        });

                        if (!response.ok) {
                            throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                        }

                        const result = await response.json();

                        let message = result.message;
                        if (photoData) {
                            message += ' ğŸ“·';
                        }

                        showManualMessage(message, result.success ? 'success' : 'error');

                        if (result.success) {
                            form.reset();
                            manualPhotoCaptured = null;
                            const manualPhotoPreview = document.getElementById('manual-photo-preview');
                            if (manualPhotoPreview) {
                                manualPhotoPreview.style.display = 'none';
                            }
                            stopManualPhotoCapture();

                            playSuccessSound();
                            speak(result.voice || result.message);
                            updateSystemStatus('æ‰‹å‹•æ‰“åˆ»å®Œäº†');
                        } else {
                            playErrorSound();
                            speak(result.voice || result.message);
                            updateSystemStatus('æ‰‹å‹•æ‰“åˆ»å¤±æ•—');
                        }

                    } catch (error) {
                        console.error('æ‰‹å‹•æ‰“åˆ»é€šä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                        const errorMessage = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message;
                        showManualMessage(errorMessage, 'error');
                        playErrorSound();
                        speak('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„');
                        updateSystemStatus('é€šä¿¡ã‚¨ãƒ©ãƒ¼');
                    }
                });
            }
        }

        async function checkPunchConsistency(employeeId, action) {
            try {
                const response = await fetch('/api/timecard/check-consistency', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        employee_id: employeeId,
                        action: action
                    })
                });

                return await response.json();
            } catch (error) {
                console.error('æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
                return { success: false, message: 'æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' };
            }
        }

        function showMessage(text, type) {
            if (messageElement) {
                messageElement.textContent = text;
                messageElement.className = 'message-box ' + type;
                messageElement.style.display = 'block';

                setTimeout(function() {
                    messageElement.style.display = 'none';
                }, 5000);
            }
        }

        function showManualMessage(text, type) {
            const manualMessage = document.getElementById('manual-message');
            if (manualMessage) {
                manualMessage.textContent = text;
                manualMessage.className = 'message-box ' + type;
                manualMessage.style.display = 'block';

                setTimeout(function() {
                    manualMessage.style.display = 'none';
                }, 5000);
            }
        }

        function speak(text) {
            if ('speechSynthesis' in window && document.getElementById('voiceEnabled').checked) {
                window.speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ja-JP';
                utterance.rate = 0.9;
                utterance.volume = Math.min(1.0, currentVolume);

                utterance.onerror = function(event) {
                    console.error('éŸ³å£°åˆæˆã‚¨ãƒ©ãƒ¼:', event.error);
                };

                window.speechSynthesis.speak(utterance);
            }
        }

        function playErrorSound() {
            try {
                if (errorSound) {
                    errorSound.volume = Math.min(1.0, currentVolume);
                    errorSound.currentTime = 0;
                    errorSound.play().catch(e => console.log('éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:', e));
                }
            } catch (error) {
                console.error('ã‚¨ãƒ©ãƒ¼éŸ³å£°å†ç”Ÿå¤±æ•—:', error);
            }
        }

        function playSuccessSound() {
            try {
                const context = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = context.createOscillator();
                const gainNode = context.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(context.destination);

                oscillator.frequency.value = 800;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0, context.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3 * currentVolume, context.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, context.currentTime + 0.3);

                oscillator.start(context.currentTime);
                oscillator.stop(context.currentTime + 0.3);
            } catch (error) {
                console.error('æˆåŠŸéŸ³å£°ç”Ÿæˆå¤±æ•—:', error);
            }
        }

        function toggleFaceAuth() {
            const enabled = document.getElementById('faceAuthEnabled').checked;

            if (!enabled) {
                if (!confirm('é¡”èªè¨¼ã‚’ç„¡åŠ¹ã«ã—ã¾ã™ã‹ï¼Ÿã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãŒä½ä¸‹ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚')) {
                    document.getElementById('faceAuthEnabled').checked = true;
                    return;
                }
            }
        }

        function startPunch(action) {
            currentAction = action;
            faceAuthCompleted = false;
            faceDetectionStopped = false;
            faceVerified = false;
            isAutoPunchInProgress = false;
            lastCapturedPhoto = null;

            updateSystemStatus('QRã‚¹ã‚­ãƒ£ãƒ³å¾…æ©Ÿä¸­');

            const buttonMessages = {
                'in': 'å‡ºå‹¤ã§ã™',
                'out': 'é€€å‹¤ã§ã™',
                'out_personal': 'é€€å‡ºã§ã™',
                'in_personal': 'æˆ»ã‚Šã§ã™'
            };

            speak(buttonMessages[action]);
            if (qrSection) {
                qrSection.style.display = 'block';
            }

            setTimeout(function() {
                initQrScanner();
            }, 500);
        }

        function initQrScanner() {
            try {
                html5QrCode = new Html5Qrcode("reader");
                const config = {
                    fps: 10,
                    qrbox: { width: 250, height: 250 },
                    aspectRatio: 1.0
                };

                html5QrCode.start(
                    { facingMode: "user" },
                    config,
                    onScanSuccess,
                    onScanError
                ).catch(function(err) {
                    console.error("QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼é–‹å§‹å¤±æ•—:", err);
                    showMessage('ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    playErrorSound();
                    updateSystemStatus('ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼');
                });
            } catch (error) {
                console.error("QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼åˆæœŸåŒ–å¤±æ•—:", error);
                showMessage('QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                playErrorSound();
                updateSystemStatus('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼');
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            console.log('QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚ŠæˆåŠŸ: ' + decodedText);
            updateSystemStatus('QRã‚³ãƒ¼ãƒ‰å‡¦ç†ä¸­');
            currentEmployeeId = decodedText;

            if (html5QrCode) {
                html5QrCode.stop().then(function() {
                    console.log("QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢");
                }).catch(function(err) {
                    console.error("QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼åœæ­¢å¤±æ•—:", err);
                });
            }

            if (qrSection) {
                qrSection.style.display = 'none';
            }

            updateSystemStatus('é¡”èªè¨¼æº–å‚™ä¸­');

            if (document.getElementById('faceAuthEnabled').checked && faceApiInitialized) {
                startFaceAuth(decodedText);
            } else if (document.getElementById('faceAuthEnabled').checked && !faceApiInitialized) {
                if (confirm('é¡”èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ãŒã¾ã åˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚é¡”èªè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦æ‰“åˆ»ã‚’ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ')) {
                    sendPunch(decodedText, currentAction, false);
                } else {
                    showMessage('é¡”èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ã‚’ãŠå¾…ã¡ãã ã•ã„', 'error');
                }
            } else {
                sendPunch(decodedText, currentAction, false);
            }
        }

        function onScanError(err) {
            // QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼ã¯é€šå¸¸ã®å‹•ä½œ
        }

        function cancelQrScan() {
            updateSystemStatus('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ä¸­');

            if (html5QrCode) {
                html5QrCode.stop().then(function() {
                    console.log("QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢");
                }).catch(function(err) {
                    console.error("QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼åœæ­¢å¤±æ•—:", err);
                });
            }

            if (qrSection) {
                qrSection.style.display = 'none';
            }

            updateSystemStatus('å¾…æ©Ÿä¸­');
        }

        async function startFaceAuth(employeeId) {
            try {
                updateSystemStatus('é¡”èªè¨¼ä¸­');

                if (!faceApiInitialized) {
                    throw new Error('é¡”èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }

                const response = await fetch('/api/face/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        employee_id: employeeId,
                        face_descriptor: []
                    })
                });

                const result = await response.json();

                if (!result.success) {
                    if (result.needs_registration) {
                        if (confirm('é¡”ãƒ‡ãƒ¼ã‚¿ãŒæœªç™»éŒ²ã§ã™ã€‚é¡”èªè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦æ‰“åˆ»ã—ã¾ã™ã‹ï¼Ÿ')) {
                            await sendPunch(employeeId, currentAction, false);
                        }
                        return;
                    } else {
                        showMessage(result.message, 'error');
                        playErrorSound();
                        return;
                    }
                }

                storedFaceDescriptor = new Float32Array(result.stored_descriptor);

                if (faceAuthSection) {
                    faceAuthSection.style.display = 'block';
                }
                faceAuthStarted = true;
                faceAuthCompleted = false;

                await initFaceCamera();
                await startFaceDetection();

            } catch (error) {
                console.error('é¡”èªè¨¼é–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('é¡”èªè¨¼ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                playErrorSound();
                updateSystemStatus('é¡”èªè¨¼ã‚¨ãƒ©ãƒ¼');

                if (confirm('é¡”èªè¨¼ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚é¡”èªè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦æ‰“åˆ»ã—ã¾ã™ã‹ï¼Ÿ')) {
                    await sendPunch(employeeId, currentAction, false);
                }
            }
        }

        async function initFaceCamera() {
            try {
                faceCanvas = document.getElementById('face-overlay');
                faceCtx = faceCanvas.getContext('2d');

                const constraints = {
                    video: {
                        facingMode: 'user',
                        width: { ideal: 640, min: 320, max: 1280 },
                        height: { ideal: 480, min: 240, max: 720 },
                        frameRate: { ideal: 30, min: 15 }
                    }
                };

                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                faceVideoElement.srcObject = stream;

                await new Promise(function(resolve, reject) {
                    const timeout = setTimeout(function() {
                        reject(new Error('ãƒ“ãƒ‡ã‚ªèª­ã¿è¾¼ã¿ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ (10ç§’)'));
                    }, 10000);

                    faceVideoElement.addEventListener('loadedmetadata', function() {
                        clearTimeout(timeout);
                        faceCanvas.width = faceVideoElement.videoWidth;
                        faceCanvas.height = faceVideoElement.videoHeight;
                        resolve();
                    }, { once: true });

                    faceVideoElement.addEventListener('error', function(e) {
                        clearTimeout(timeout);
                        reject(new Error('ãƒ“ãƒ‡ã‚ªèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + e.message));
                    }, { once: true });
                });

                await new Promise(function(resolve, reject) {
                    const timeout = setTimeout(function() {
                        reject(new Error('ãƒ“ãƒ‡ã‚ªå†ç”Ÿæº–å‚™ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ (5ç§’)'));
                    }, 5000);

                    if (faceVideoElement.readyState >= 3) {
                        clearTimeout(timeout);
                        resolve();
                        return;
                    }

                    faceVideoElement.addEventListener('canplay', function() {
                        clearTimeout(timeout);
                        resolve();
                    }, { once: true });
                });

            } catch (error) {
                console.error('é¡”èªè¨¼ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                throw error;
            }
        }

        async function startFaceDetection() {
            if (!faceApiInitialized || !faceVideoElement || faceDetectionStopped) return;

            faceDetectionInterval = setInterval(async function() {
                try {
                    if (faceAuthCompleted || faceDetectionStopped) {
                        clearInterval(faceDetectionInterval);
                        return;
                    }

                    const detection = await faceapi
                        .detectSingleFace(faceVideoElement, new faceapi.TinyFaceDetectorOptions())
                        .withFaceLandmarks()
                        .withFaceDescriptor();

                    if (faceCtx && faceCanvas) {
                        faceCtx.clearRect(0, 0, faceCanvas.width, faceCanvas.height);
                    }

                    if (detection) {
                        const box = detection.detection.box;
                        const scaleX = faceCanvas.width / faceVideoElement.videoWidth;
                        const scaleY = faceCanvas.height / faceVideoElement.videoHeight;

                        faceCtx.strokeStyle = '#00ff00';
                        faceCtx.lineWidth = 3;
                        faceCtx.strokeRect(
                            box.x * scaleX,
                            box.y * scaleY,
                            box.width * scaleX,
                            box.height * scaleY
                        );

                        currentFaceDescriptor = detection.descriptor;

                        if (storedFaceDescriptor && !faceAuthCompleted) {
                            const distance = faceapi.euclideanDistance(currentFaceDescriptor, storedFaceDescriptor);
                            faceSimilarity = Math.max(0, 1 - distance);

                            const threshold = 0.6;
                            const verified = faceSimilarity >= threshold;

                            updateFaceStatus(verified, faceSimilarity);

                            if (verified && !faceAuthCompleted) {
                                faceAuthCompleted = true;
                                faceDetectionStopped = true;
                                clearInterval(faceDetectionInterval);

                                console.log('é¡”èªè¨¼æˆåŠŸã€æ¤œå‡ºåœæ­¢');

                                if (document.getElementById('photoCaptureEnabled').checked) {
                                    await capturePhotoOnFaceAuth();
                                }

                                if (document.getElementById('autoPunchEnabled').checked && !isAutoPunchInProgress) {
                                    setTimeout(function() {
                                        startAutoPunchCountdown();
                                    }, 1000);
                                }
                            }
                        }
                    } else {
                        currentFaceDescriptor = null;
                        if (!faceAuthCompleted) {
                            updateFaceStatus(false, 0);
                        }
                    }
                } catch (error) {
                    console.error('é¡”æ¤œå‡ºã‚¨ãƒ©ãƒ¼:', error);
                    if (!faceAuthCompleted) {
                        stopFaceDetection();
                        alert('é¡”æ¤œå‡ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚');
                    }
                }
            }, 500);
        }

        function updateFaceStatus(verified, similarity) {
            const statusDiv = document.getElementById('face-status');
            const similarityDiv = document.getElementById('similarity-display');
            const proceedBtn = document.getElementById('proceed-btn');

            if (currentFaceDescriptor) {
                if (verified) {
                    if (statusDiv) statusDiv.textContent = 'âœ… é¡”èªè¨¼æˆåŠŸ';
                    if (statusDiv) statusDiv.className = 'face-status face-verified';
                    if (similarityDiv) similarityDiv.textContent = 'é¡ä¼¼åº¦: ' + (similarity * 100).toFixed(1) + '%';
                    if (proceedBtn) proceedBtn.disabled = false;
                    faceVerified = true;
                } else {
                    if (statusDiv) statusDiv.textContent = 'âŒ é¡”èªè¨¼å¤±æ•—';
                    if (statusDiv) statusDiv.className = 'face-status face-failed';
                    if (similarityDiv) similarityDiv.textContent = 'é¡ä¼¼åº¦: ' + (similarity * 100).toFixed(1) + '% (é–¾å€¤: 60%)';
                    if (proceedBtn) proceedBtn.disabled = true;
                    faceVerified = false;
                }
            } else {
                if (!faceAuthCompleted) {
                    if (statusDiv) statusDiv.textContent = 'ğŸ˜Š é¡”ã‚’æ¤œå‡ºä¸­...';
                    if (statusDiv) statusDiv.className = 'face-status face-not-detected';
                    if (similarityDiv) similarityDiv.textContent = '';
                    if (proceedBtn) proceedBtn.disabled = true;
                    faceVerified = false;
                }
            }
        }

        function stopFaceDetection() {
            faceDetectionStopped = true;

            if (faceDetectionInterval) {
                clearInterval(faceDetectionInterval);
                faceDetectionInterval = null;
            }

            if (faceCtx && faceCanvas) {
                faceCtx.clearRect(0, 0, faceCanvas.width, faceCanvas.height);
            }

            if (faceVideoElement && faceVideoElement.srcObject) {
                faceVideoElement.srcObject.getTracks().forEach(function(track) {
                    track.stop();
                });
                faceVideoElement.srcObject = null;
            }
        }

        function startAutoPunchCountdown() {
            if (isAutoPunchInProgress || !faceAuthCompleted) {
                return;
            }

            const countdownDiv = document.getElementById('auto-punch-countdown');
            const countdownNumber = document.getElementById('countdown-number');

            if (countdownDiv && countdownNumber) {
                isAutoPunchInProgress = true;
                countdownDiv.style.display = 'block';
                let countdown = 3;
                countdownNumber.textContent = countdown;

                speak('é¡”èªè¨¼æˆåŠŸã€‚3ç§’å¾Œã«è‡ªå‹•æ‰“åˆ»ã—ã¾ã™');

                autoPunchCountdown = setInterval(function() {
                    countdown--;
                    countdownNumber.textContent = countdown;

                    if (countdown <= 0) {
                        clearInterval(autoPunchCountdown);
                        countdownDiv.style.display = 'none';
                        isAutoPunchInProgress = false;
                        executeAutoPunch();
                    }
                }, 1000);
            }
        }

        function executeAutoPunch() {
            if (!currentEmployeeId || !currentAction) {
                console.error('è‡ªå‹•æ‰“åˆ»ã‚¨ãƒ©ãƒ¼: å¾“æ¥­å“¡IDã¾ãŸã¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                isAutoPunchInProgress = false;
                updateSystemStatus('è‡ªå‹•æ‰“åˆ»ã‚¨ãƒ©ãƒ¼');
                return;
            }

            if (!faceVerified || !faceAuthCompleted) {
                console.error('è‡ªå‹•æ‰“åˆ»ã‚¨ãƒ©ãƒ¼: é¡”èªè¨¼ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“');
                isAutoPunchInProgress = false;
                updateSystemStatus('é¡”èªè¨¼ã‚¨ãƒ©ãƒ¼');
                return;
            }

            updateSystemStatus('è‡ªå‹•æ‰“åˆ»å®Ÿè¡Œä¸­');
            sendPunch(currentEmployeeId, currentAction, faceVerified, faceSimilarity);
        }

        async function sendPunch(employeeId, action, useFaceAuth, similarity) {
            try {
                updateSystemStatus('æ‰“åˆ»ãƒ‡ãƒ¼ã‚¿é€ä¿¡ä¸­');

                const consistencyCheck = await checkPunchConsistency(employeeId, action);
                if (!consistencyCheck.success) {
                    showMessage(consistencyCheck.message, 'error');
                    playErrorSound();
                    speak(consistencyCheck.message);
                    updateSystemStatus('æ•´åˆæ€§ã‚¨ãƒ©ãƒ¼');
                    resetFaceAuthSystem();
                    return;
                }

                let photoData = null;

                if (document.getElementById('photoCaptureEnabled').checked) {
                    if (useFaceAuth && lastCapturedPhoto) {
                        photoData = lastCapturedPhoto;
                        console.log('æ—¢å­˜æ’®å½±å†™çœŸä½¿ç”¨: ' + Math.round(photoData.length / 1024) + 'KB');
                    } else {
                        photoData = await capturePhoto();
                        if (photoData) {
                            console.log('æ–°è¦å†™çœŸæ’®å½±æˆåŠŸ: ' + Math.round(photoData.length / 1024) + 'KB');
                        }
                    }
                }

                const requestData = {
                    employee_id: employeeId,
                    action: action,
                    photo: photoData
                };

                if (useFaceAuth) {
                    requestData.face_verified = faceVerified;
                    requestData.face_similarity = similarity;
                }

                const response = await fetch('/api/timecard', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();

                if (result.success) {
                    let message = useFaceAuth
                        ? result.message + ' (é¡ä¼¼åº¦: ' + (similarity * 100).toFixed(1) + '%)'
                        : result.message;

                    if (result.photo_saved) {
                        message += ' ğŸ“·';
                    } else if (photoData) {
                        message += ' (å†™çœŸä¿å­˜å¤±æ•—)';
                    }

                    showMessage(message, 'success');
                    playSuccessSound();
                    speak(result.voice || result.message);
                    updateSystemStatus('æ‰“åˆ»å®Œäº†');
                } else {
                    showMessage(result.message, 'error');
                    playErrorSound();
                    updateSystemStatus('æ‰“åˆ»å¤±æ•—');
                    speak(result.voice || result.message);
                }

                resetFaceAuthSystem();

            } catch (error) {
                console.error('æ‰“åˆ»é€šä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                playErrorSound();
                speak('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                updateSystemStatus('é€šä¿¡ã‚¨ãƒ©ãƒ¼');
                resetFaceAuthSystem();
            }
        }

        function resetFaceAuthSystem() {
            console.log('é¡”èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚»ãƒƒãƒˆ');

            faceAuthCompleted = false;
            faceDetectionStopped = false;
            faceVerified = false;
            isAutoPunchInProgress = false;
            faceAuthStarted = false;
            lastCapturedPhoto = null;
            currentFaceDescriptor = null;
            storedFaceDescriptor = null;
            faceSimilarity = 0;

            if (autoPunchCountdown) {
                clearInterval(autoPunchCountdown);
                autoPunchCountdown = null;
            }

            const countdownDiv = document.getElementById('auto-punch-countdown');
            if (countdownDiv) {
                countdownDiv.style.display = 'none';
            }

            const photoPreview = document.getElementById('photo-preview');
            if (photoPreview) {
                photoPreview.style.display = 'none';
            }

            const photoCaptureStatus = document.getElementById('photo-capture-status');
            if (photoCaptureStatus) {
                photoCaptureStatus.style.display = 'none';
            }

            if (faceAuthSection) {
                faceAuthSection.style.display = 'none';
            }

            stopFaceDetection();

            currentAction = null;
            currentEmployeeId = null;

            setTimeout(function() {
                updateSystemStatus('å¾…æ©Ÿä¸­');
            }, 2000);
        }

        function proceedToPunch() {
            updateSystemStatus('æ‰“åˆ»å‡¦ç†ä¸­');

            if (document.getElementById('autoPunchEnabled').checked && !faceVerified) {
                showMessage('é¡”èªè¨¼ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“', 'error');
                updateSystemStatus('é¡”èªè¨¼ã‚¨ãƒ©ãƒ¼');
                return;
            }

            stopFaceDetection();
            if (faceAuthSection) {
                faceAuthSection.style.display = 'none';
            }

            sendPunch(currentEmployeeId, currentAction, faceVerified, faceSimilarity);
        }

        function skipFaceAuth() {
            if (confirm('é¡”èªè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦æ‰“åˆ»ã—ã¾ã™ã‹ï¼Ÿ')) {
                updateSystemStatus('é¡”èªè¨¼ã‚¹ã‚­ãƒƒãƒ—');
                stopFaceDetection();
                if (faceAuthSection) {
                    faceAuthSection.style.display = 'none';
                }
                sendPunch(currentEmployeeId, currentAction, false);
            }
        }

        function cancelFaceAuth() {
            updateSystemStatus('ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
            resetFaceAuthSystem();
        }

        // ãƒšãƒ¼ã‚¸å¯è¦–æ€§ç®¡ç†
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                if (html5QrCode && html5QrCode.pause) {
                    html5QrCode.pause().catch(function(e) {
                        console.log('QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ä¸€æ™‚åœæ­¢ã‚¨ãƒ©ãƒ¼:', e);
                    });
                }
                stopFaceDetection();
                stopManualPhotoCapture();
            } else if (!document.hidden) {
                if (html5QrCode && html5QrCode.resume && qrSection && qrSection.style.display === 'block') {
                    html5QrCode.resume().catch(function(e) {
                        console.log('QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼å†é–‹ã‚¨ãƒ©ãƒ¼:', e);
                    });
                }
                if (faceAuthSection && faceAuthSection.style.display === 'block' && !faceAuthCompleted) {
                    startFaceDetection();
                }
            }
        });

        // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', function() {
            if (html5QrCode) {
                html5QrCode.stop().catch(function(e) {
                    console.log('QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼åœæ­¢ã‚¨ãƒ©ãƒ¼:', e);
                });
            }
            stopFaceDetection();
            stopManualPhotoCapture();
        });

        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        window.addEventListener('error', function(event) {
            console.error('ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼:', event.error);
        });
    </script>
</body>

</html>