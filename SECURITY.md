# セキュリティガイド

## 重要な修正内容

このドキュメントでは、システムに加えられたセキュリティ強化について説明します。

## 修正されたセキュリティ問題

### 1. パスワードハッシュ化の強化 ✅

**以前**: SHA256による単純なハッシュ化（ソルトなし）
```python
# 脆弱な実装
hashlib.sha256(password.encode()).hexdigest()
```

**修正後**: Werkzeugのpbkdf2:sha256によるセキュアなハッシュ化
```python
# セキュアな実装
from werkzeug.security import generate_password_hash, check_password_hash
generate_password_hash(password, method='pbkdf2:sha256')
```

### 2. デフォルトパスワードの改善 ✅

**以前**: ハードコードされたデフォルトパスワード (`admin/admin_password`)

**修正後**:
- 初回起動時にランダムなパスワードを生成
- コンソールに一時パスワードを表示
- 初回ログイン後の変更を推奨

### 3. SECRET_KEY検証 ✅

**以前**: デフォルト値のまま使用される可能性

**修正後**:
- 本番環境ではSECRET_KEYが必須
- デフォルト値の場合はエラーを表示
- 開発環境では一時的なキーを自動生成

### 4. パスワード強度チェック ✅

**追加機能**:
- パスワードは8文字以上必須（以前は6文字）
- パスワードリセット時も同様のチェック

### 5. OS対応のパス処理 ✅

**以前**: Linuxパス（`/home`）がハードコード

**修正後**:
- OS判定による適切なパス設定
- Windows対応の追加

## 初回セットアップ手順

### 1. 環境変数の設定

`.env.production.example` をコピーして `.env` を作成:

```bash
cp .env.production.example .env
```

`.env` ファイルを編集し、必ず以下を変更:

```bash
# SECRET_KEYを生成
python -c "import secrets; print(secrets.token_hex(32))"

# 生成されたキーを.envに設定
SECRET_KEY=生成されたキー
```

### 2. 初回起動

```bash
python startup.py
```

コンソールに表示される一時パスワードをメモしてください:

```
============================================================
デフォルト管理者ユーザーを作成しました
ユーザー名: admin
一時パスワード: XXXXXXXXXXXXXXXX
初回ログイン後、必ずパスワードを変更してください！
============================================================
```

### 3. 初回ログイン後の設定

1. ログイン (`admin` と一時パスワード)
2. **すぐにパスワードを変更**
3. メール設定を完了（パスワードリセット機能用）

## 本番環境へのデプロイ

### Azure App Serviceの場合

1. **アプリケーション設定で環境変数を設定**:
   - `SECRET_KEY`: ランダムな文字列
   - `FLASK_ENV`: `production`
   - `EMAIL_USERNAME`: SMTPユーザー名
   - `EMAIL_PASSWORD`: SMTPパスワード
   - `ADMIN_EMAIL`: 管理者メール

2. **デプロイ後の確認**:
   - ログを確認
   - 一時パスワードをメモ
   - すぐにパスワード変更

## セキュリティベストプラクティス

### 必須事項

1. ✅ **SECRET_KEYを変更**: デフォルト値は絶対に使用しない
2. ✅ **初回パスワード変更**: デフォルトパスワードをすぐに変更
3. ✅ **強力なパスワード**: 8文字以上、複雑なパスワードを使用
4. ✅ **.envファイルを保護**: `.gitignore`に追加済み
5. ✅ **HTTPS使用**: 本番環境では必ずHTTPSを使用

### 推奨事項

- 定期的なパスワード変更
- アクセスログの監視
- 依存ライブラリの定期更新
- バックアップの定期的な取得

## トラブルシューティング

### SECRET_KEYエラー

```
致命的エラー: SECRET_KEYが設定されていないか、デフォルト値のままです。
```

**解決方法**: 環境変数 `SECRET_KEY` を設定

### 一時パスワードが見つからない

**解決方法**:
1. データベースファイル (`timecard.db`) を削除
2. アプリケーションを再起動
3. 新しい一時パスワードが生成されます

### パスワードリセットメールが届かない

**確認事項**:
1. `EMAIL_USERNAME`, `EMAIL_PASSWORD` が正しく設定されているか
2. Gmailの場合、アプリパスワードを使用しているか
3. ファイアウォールでSMTPポート（587）が開いているか

## セキュリティに関する問い合わせ

セキュリティに関する問題を発見した場合は、GitHubのIssuesで報告してください。

---

**最終更新**: 2025-01-07
