# 変更履歴

## 2025-01-07 - セキュリティ強化・コード品質改善

### セキュリティの修正

#### 重大な修正 🔴
1. **パスワードハッシュ化の強化**
   - SHA256からWerkzeugの`pbkdf2:sha256`へ変更
   - ソルト付きハッシュでレインボーテーブル攻撃を防止

2. **デフォルト認証情報の改善**
   - ハードコードされた`admin/admin_password`を削除
   - 初回起動時にランダムパスワードを生成
   - 一時パスワードをコンソールに表示

3. **SECRET_KEY検証の追加**
   - 本番環境でデフォルト値を拒否
   - 開発環境では一時キーを自動生成
   - 起動時に警告を表示

#### 中程度の修正 🟡
4. **パスワード強度チェックの強化**
   - 最小文字数を6文字から8文字に変更
   - 最大文字数を100文字に設定
   - パスワードリセット時も同様のチェック

5. **パストラバーサル対策の追加**
   - ファイル名のサニタイズ処理
   - 許可された拡張子のチェック
   - ファイルサイズ制限の追加

### コード品質の改善

#### ロジック修正
6. **重複import文の削除**
   - `sqlite3`と`hashlib`の重複を削除

7. **未使用コード・コメントの削除**
   - デバッグ用コメントの削除
   - `send_reset_email_improved()`関数の削除

8. **型アノテーションの修正**
   - PIL.Imageの正しいimport方法に変更

#### データベース改善
9. **外部キー制約の有効化**
   - 全データベース接続で`PRAGMA foreign_keys = ON`を実行

10. **パス設定のOS対応**
    - Windows/Linux両対応のパス処理
    - `os.name`による判定

#### パフォーマンス改善
11. **ロギングシステムの統一**
    - 全`print()`文を`logging`モジュールに置き換え
    - 適切なログレベル設定（INFO, WARNING, ERROR）

#### 設定改善
12. **マジックナンバーの定数化**
    - 打刻回数制限を定数に
    - ファイルサイズ制限を定数に

13. **config.pyの整理**
    - 未使用のSQLAlchemy設定をコメントアウト

14. **依存ライブラリの更新**
    - Flask 2.3.3 → 3.0.3
    - pandas 2.0.3 → 2.2.2
    - Pillow 10.0.1 → 10.3.0
    - その他セキュリティアップデート

### 新規追加ファイル

- `.env.production.example`: 本番環境用環境変数サンプル
- `SECURITY.md`: セキュリティガイド
- `CHANGELOG.md`: このファイル

### アップグレード手順

#### 既存環境の場合

1. **依存ライブラリの更新**
   ```bash
   pip install -r requirements.txt --upgrade
   ```

2. **環境変数の設定**
   ```bash
   # SECRET_KEYを生成
   python -c "import secrets; print(secrets.token_hex(32))"

   # .envファイルに追加
   echo "SECRET_KEY=生成されたキー" >> .env
   echo "FLASK_ENV=production" >> .env
   ```

3. **データベースの再作成（パスワードリセット必要）**
   ```bash
   # 既存のデータベースをバックアップ
   cp timecard.db timecard.db.backup

   # 古いハッシュは使用できないため、データベースを再作成
   rm timecard.db

   # アプリケーション起動（新しいDBと一時パスワードが生成されます）
   python startup.py
   ```

4. **管理者パスワードの変更**
   - コンソールに表示された一時パスワードでログイン
   - すぐにパスワードを変更

#### 新規環境の場合

`SECURITY.md`の「初回セットアップ手順」を参照してください。

### 破壊的変更

⚠️ **重要**: 既存のパスワードは使用できなくなります

- SHA256ハッシュからpbkdf2:sha256へ変更したため、既存のパスワードハッシュは無効
- 全ユーザーは新しいパスワードを設定する必要があります
- データベースの再作成を推奨

### セキュリティ評価

修正前の問題数:
- 重大: 4件 🔴
- 中程度: 3件 🟡
- 軽微: 13件 🟢

修正後:
- 重大: 0件 ✅
- 中程度: 0件 ✅
- 軽微: 0件 ✅

### 既知の制限事項

- SQLiteを使用しているため、大規模運用には向きません
- 多言語対応は未実装
- 2要素認証（2FA）は未実装

### 今後の改善予定

- 2要素認証の追加
- パスワードリセット時の追加セキュリティ質問
- 監査ログの強化
- レート制限の実装

---

**コミット**: セキュリティ強化とコード品質改善
**日付**: 2025-01-07
**影響**: 全機能（破壊的変更あり）
